
<div class="min-h-screen bg-gray-900 text-gray-100 flex flex-col p-4 sm:p-6 lg:p-8 relative">
  <header class="w-full max-w-7xl mx-auto text-center mb-8">
    <div class="flex items-center justify-center gap-4 mb-2">
       <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
      </svg>
      <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600">
        AI Video Finder
      </h1>
    </div>
    <p class="text-lg text-gray-400 mt-2">
      Enter a webpage URL and let our AI discover all downloadable videos for you.
    </p>
  </header>

  <div class="w-full max-w-7xl mx-auto flex-grow flex flex-col md:flex-row gap-8">
    
    <!-- Main Content -->
    <main class="flex-grow w-full md:w-2/3 lg:w-3/4 order-2 md:order-1">
      <form (ngSubmit)="findVideos()" class="mb-8">
        <div class="relative">
          <input
            type="text"
            [ngModel]="url()"
            (ngModelChange)="onUrlChange($event)"
            name="url"
            placeholder="https://www.youtube.com/watch?v=..."
            class="w-full pl-4 pr-36 py-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-all duration-300"
            [disabled]="isLoading()"
          />
          <button
            type="submit"
            class="absolute right-2 top-1/2 -translate-y-1/2 bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-md flex items-center gap-2 transition-all duration-300"
            [disabled]="isLoading() || !url()"
          >
            @if(isLoading()){
              <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span>Analyzing...</span>
            } @else {
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <span>Find Videos</span>
            }
          </button>
        </div>
         @if (error()) {
          <p class="text-red-400 mt-2 text-center">{{ error() }}</p>
        }
      </form>

      <!-- Filter/Sort Controls -->
      @if (videoGroups().length > 0) {
        <div class="flex flex-col sm:flex-row flex-wrap items-center justify-between gap-4 mb-6 p-4 bg-gray-800/50 rounded-lg">
          <div class="flex items-center gap-2">
             <label for="category-filter" class="text-sm font-medium text-gray-400">Category:</label>
             <select id="category-filter" [ngModel]="selectedCategory()" (ngModelChange)="setCategoryFilter($event)" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 p-1.5">
                @for(category of allCategories(); track category) {
                  <option [value]="category">{{ category === 'all' ? 'All Categories' : category }}</option>
                }
             </select>
          </div>
           <div class="flex items-center gap-2">
             <label for="sort-by" class="text-sm font-medium text-gray-400">Sort by:</label>
             <select id="sort-by" [ngModel]="sortBy()" (ngModelChange)="setSortBy($event)" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 p-1.5">
               <option value="popularity">Popularity</option>
               <option value="date">Newest</option>
               <option value="title">Title</option>
             </select>
          </div>
        </div>
      }

      <div class="results-container">
        @if (isLoading()) {
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            @for (_ of [1,2,3,4,5,6]; track $index) {
              <div class="bg-gray-800 rounded-lg p-4 animate-pulse">
                <div class="w-full h-32 bg-gray-700 rounded mb-4"></div>
                <div class="h-4 bg-gray-700 rounded w-3/4 mb-2"></div>
                <div class="h-4 bg-gray-700 rounded w-1/2"></div>
                <div class="h-10 bg-gray-700 rounded w-full mt-4"></div>
              </div>
            }
          </div>
        } @else if (hasSearched() && videoGroups().length > 0) {
           <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            @for (group of filteredVideoGroups(); track group.title) {
              <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden flex flex-col transition-transform duration-300 hover:scale-105 hover:shadow-cyan-500/20">
                <div class="bg-black flex items-center justify-center h-40 relative overflow-hidden">
                   @if(group.thumbnailUrl) {
                    <img [src]="group.thumbnailUrl" [alt]="group.title" class="w-full h-full object-cover">
                   } @else {
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                       <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                     </svg>
                   }
                   @if(group.category) {
                      <span class="absolute top-2 left-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-900/70 text-gray-200 backdrop-blur-sm">
                        {{ group.category }}
                      </span>
                   }
                </div>
                <div class="p-4 flex flex-col flex-grow">
                  <h3 class="font-bold text-lg text-gray-200" [title]="group.title">{{ group.title }}</h3>
                   @if (group.popularity !== undefined && group.popularity !== null) {
                    <div class="w-full my-3">
                      <span class="text-xs font-semibold inline-block text-teal-400">Popularity</span>
                      <div class="overflow-hidden h-2 text-xs flex rounded bg-teal-800">
                        <div [style.width.%]="group.popularity" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-teal-500 transition-all duration-500"></div>
                      </div>
                    </div>
                  }
                  <div class="flex-grow"></div>
                  <button (click)="openDownloadModal(group)" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center gap-2 transition-colors duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    <span>Choose Quality</span>
                  </button>
                </div>
              </div>
            }
          </div>
          @if (filteredVideoGroups().length === 0) {
            <div class="text-center py-16 px-6 bg-gray-800 rounded-lg">
              <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
              <h3 class="mt-2 text-xl font-medium text-gray-300">No Videos Match Filters</h3>
              <p class="mt-1 text-gray-400">Try selecting a different category or changing the sort order.</p>
            </div>
          }
        } @else if(hasSearched() && videoGroups().length === 0) {
          <div class="text-center py-16 px-6 bg-gray-800 rounded-lg">
             <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            <h3 class="mt-2 text-xl font-medium text-gray-300">No Videos Found</h3>
            <p class="mt-1 text-gray-400">The AI couldn't find any downloadable videos on that page. Try another URL.</p>
          </div>
        }
      </div>
    </main>

    <!-- History Sidebar -->
    <aside class="w-full md:w-1/3 lg:w-1/4 order-1 md:order-2">
      @if (urlHistory().length > 0) {
        <div class="bg-gray-800 rounded-lg p-4 sticky top-8">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-200">Search History</h3>
            <button (click)="clearHistory()" class="text-sm text-cyan-400 hover:text-cyan-300 transition-colors">Clear</button>
          </div>
          <ul class="space-y-2 max-h-96 overflow-y-auto">
            @for (histUrl of urlHistory(); track histUrl) {
              <li>
                <button (click)="loadFromHistory(histUrl)" class="w-full text-left text-sm text-gray-400 hover:bg-gray-700 hover:text-gray-200 p-2 rounded truncate transition-colors" [title]="histUrl">
                  {{ histUrl }}
                </button>
              </li>
            }
          </ul>
        </div>
      }
    </aside>
  </div>

  <!-- Download Modal -->
  @if (isModalOpen() && selectedVideoGroup(); as group) {
    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" (click)="closeModal()">
      <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col" (click)="$event.stopPropagation()">
        <header class="p-4 border-b border-gray-700 flex justify-between items-center">
          <h2 class="text-lg font-bold text-gray-200 truncate pr-4">{{ group.title }}</h2>
          <button (click)="closeModal()" class="text-gray-400 hover:text-white">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </header>
        <div class="p-4 overflow-y-auto">
          <p class="text-sm text-gray-400 mb-4">Select a format and quality to download:</p>
          <ul class="space-y-2">
            @for(variant of group.variants; track variant.url) {
              <li class="bg-gray-700/50 p-3 rounded-md flex items-center justify-between gap-2">
                <div class="flex-grow">
                  <span class="font-semibold text-gray-200">{{ variant.resolution }}</span>
                   @if(variant.sizeMb) {
                    <span class="text-xs text-gray-400 ml-2">({{ variant.sizeMb }} MB)</span>
                   }
                </div>
                <span class="text-xs font-medium px-2 py-1 rounded-full bg-cyan-900 text-cyan-300">{{ variant.format.toUpperCase() }}</span>
                @if(variant.isProtected) {
                  <div class="flex items-center gap-2">
                    <div class="relative group">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                      </svg>
                       <div class="absolute bottom-full mb-2 w-60 bg-gray-900 text-gray-200 text-xs rounded py-2 px-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none left-1/2 -translate-x-1/2">
                        This is a temporary link. Copy and paste it into a download manager or VLC player immediately for best results.
                        <div class="w-2 h-2 bg-gray-900 absolute left-1/2 -translate-x-1/2 rotate-45 -bottom-1"></div>
                      </div>
                    </div>
                     <button (click)="copyToClipboard(variant.url)" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-1.5 px-3 rounded-md flex items-center justify-center gap-2 text-sm transition-colors w-28">
                       @if (copiedUrl() === variant.url) {
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                         <span>Copied!</span>
                       } @else {
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg>
                         <span>Copy Link</span>
                       }
                     </button>
                  </div>
                } @else {
                  <a [href]="variant.url" [download]="getDownloadFilename(group.title, variant)" target="_blank" rel="noopener noreferrer" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded-md flex items-center justify-center gap-2 text-sm transition-colors w-28" (click)="closeModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    <span>Download</span>
                  </a>
                }
              </li>
            } @empty {
              <li class="text-center text-gray-500 py-4">No download options available for this video.</li>
            }
          </ul>
        </div>
      </div>
    </div>
  }
</div>
